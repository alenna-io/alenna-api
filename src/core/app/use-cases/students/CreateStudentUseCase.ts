import { IStudentRepository } from '../../../adapters_interface/repositories';
import { Student } from '../../../domain/entities';
import { CreateStudentInput } from '../../dtos';
import { PrismaClient } from '@prisma/client';
import { randomUUID } from 'crypto';

const prisma = new PrismaClient();

export class CreateStudentUseCase {
  constructor(private studentRepository: IStudentRepository) {}

  async execute(input: CreateStudentInput, schoolId: string): Promise<Student> {
    // 1. Get STUDENT role
    const studentRole = await prisma.role.findFirst({
      where: { name: 'STUDENT', schoolId: null },
    });

    if (!studentRole) {
      throw new Error('STUDENT role not found in system');
    }

    // 2. Create User account for student
    const userId = randomUUID();
    const userEmail = `student.${userId.substring(0, 8)}@${schoolId}.alenna.io`; // Unique email
    
    const user = await prisma.user.create({
      data: {
        id: userId,
        clerkId: `student_${userId}_clerk`, // Placeholder - will be set on first login
        email: userEmail,
        firstName: input.firstName,
        lastName: input.lastName,
        schoolId,
      },
    });

    // 3. Assign STUDENT role
    await prisma.userRole.create({
      data: {
        id: randomUUID(),
        userId: user.id,
        roleId: studentRole.id,
      },
    });

    // 4. Calculate age from birthDate
    const birthDate = new Date(input.birthDate);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }

    // 5. Create Student entity (using data from input + calculated age)
    const student = Student.create({
      id: '', // Will be generated by database
      firstName: input.firstName,
      lastName: input.lastName,
      age, // Calculated from birthDate
      birthDate,
      certificationTypeId: input.certificationTypeId,
      certificationType: { id: input.certificationTypeId, name: '', isActive: true }, // Will be populated by repository
      graduationDate: new Date(input.graduationDate),
      schoolId,
      contactPhone: input.contactPhone,
      isLeveled: input.isLeveled || false,
      expectedLevel: input.expectedLevel,
      currentLevel: input.currentLevel,
      address: input.address,
      parents: [],
    });

    // 6. Create Student record linked to User
    return this.studentRepository.createWithUser(student, user.id);
  }
}

