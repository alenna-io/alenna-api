generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SchoolStatus {
  ACTIVE
  INACTIVE
  DELETED
}

model School {
  id                  String               @id @default(cuid())
  name                String               @db.VarChar(100)
  address             String?
  phone               String?
  email               String?
  logoUrl             String?               @map("logo_url")
  teacherLimit        Int?                 @map("teacher_limit")
  userLimit           Int?                 @map("user_limit")
  status              SchoolStatus         @default(ACTIVE) @map("status")
  deletedAt           DateTime?            @map("deleted_at")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  schoolYears         SchoolYear[]
  students            Student[]
  users               User[]

  @@map("schools")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  DELETED
}

model User {
  id              String           @id @default(cuid())
  clerkId         String?          @unique @map("clerk_id")
  email           String           @unique
  firstName       String?          @map("first_name")
  lastName        String?          @map("last_name")
  phone           String?          @map("phone")
  streetAddress   String?          @map("street_address")
  city            String?
  state           String?
  country         String?
  zipCode         String?          @map("zip_code")
  schoolId        String           @map("school_id")
  status          UserStatus       @default(ACTIVE) @map("status")
  deletedAt       DateTime?        @map("deleted_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  language        String?          @default("es")
  createdPassword Boolean          @default(false) @map("created_password")
  student         Student?
  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  userRoles       UserRole[]

  @@index([schoolId])
  @@index([clerkId])
  @@map("users")
}

enum RoleType {
  SCHOOL_ADMIN
  STUDENT
}

model Role {
  id          String     @id @default(cuid())
  name        RoleType   @unique
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  userRoles   UserRole[]

  @@map("roles")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

enum SchoolYearStatus {
  CURRENT_YEAR
  ARCHIVED
}

model SchoolYear {
  id                               String                            @id @default(cuid())
  schoolId                         String                            @map("school_id")
  name                             String
  startDate                        DateTime                          @map("start_date")
  endDate                          DateTime                          @map("end_date")
  status                           SchoolYearStatus                  @default(CURRENT_YEAR) @map("status")
  deletedAt                        DateTime?                         @map("deleted_at")
  createdAt                        DateTime                          @default(now()) @map("created_at")
  updatedAt                        DateTime                          @updatedAt @map("updated_at")
  quarters                         Quarter[]
  monthlyGoalTemplates             MonthlyGoalTemplate[]
  quarterGradePercentages          QuarterGradePercentage[]
  school                           School                            @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("school_years")
}

enum QuarterStatus {
  OPEN
  CLOSED
}

model Quarter {
  id              String           @id @default(cuid())
  schoolYearId    String           @map("school_year_id")
  name            String
  startDate       DateTime         @map("start_date")
  endDate         DateTime         @map("end_date")
  order           Int
  weeksCount      Int              @default(9) @map("weeks_count")
  status          QuarterStatus    @default(OPEN) @map("status")
  closedAt        DateTime?        @map("closed_at")
  closedBy        String?          @map("closed_by")
  deletedAt       DateTime?        @map("deleted_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  schoolYear      SchoolYear       @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  schoolWeeks     SchoolWeek[]

  @@unique([schoolYearId, name])
  @@unique([schoolYearId, order])
  @@index([schoolYearId])
  @@map("quarters")
}

model SchoolWeek {
  id         String    @id @default(cuid())
  quarterId  String    @map("quarter_id")
  weekNumber Int       @map("week_number")
  startDate  DateTime  @map("start_date")
  endDate    DateTime  @map("end_date")
  deletedAt  DateTime? @map("deleted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  quarter    Quarter   @relation(fields: [quarterId], references: [id], onDelete: Cascade)

  @@unique([quarterId, weekNumber])
  @@index([quarterId])
  @@map("school_weeks")
}

enum StudentStatus {
  ENROLLED
  ON_TRACK
  BEHIND_SCHEDULE
  AHEAD_OF_SCHEDULE
  GRADUATED
  INACTIVE
}

model Student {
  id                  String            @id @default(cuid())
  userId              String            @unique @map("user_id")
  schoolId            String            @map("school_id")
  deletedAt           DateTime?         @map("deleted_at")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")
  projections         Projection[]
  school              School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("students")
}

enum ProjectionStatus {
  OPEN
  CLOSED
}

model Projection {
  id                 String              @id @default(cuid())
  studentId          String
  schoolId           String
  schoolYear         String
  status             ProjectionStatus    @default(OPEN)
  deletedAt          DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  dailyGoals         DailyGoal[]
  projectionPaces    ProjectionPace[]
  projectionMonthlyGoals ProjectionMonthlyGoal[]
  student            Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([studentId, schoolYear, status])
  @@map("projections")
}

enum ProjectionMonthlyGoalStatus {
  PENDING
  COMPLETED
  FAILED
}

model MonthlyGoalTemplate {
  id                String                  @id @default(cuid())
  name              String
  quarter           String
  schoolYearId      String                  @map("school_year_id")
  schoolId          String                  @map("school_id")
  deletedAt         DateTime?               @map("deleted_at")
  createdAt         DateTime                @default(now()) @map("created_at")
  updatedAt         DateTime                @updatedAt @map("updated_at")
  schoolYear        SchoolYear              @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  projectionMonthlyGoals ProjectionMonthlyGoal[]

  @@unique([schoolYearId, quarter, name])
  @@index([schoolYearId])
  @@index([schoolYearId, quarter])
  @@map("monthly_goal_templates")
}

model QuarterGradePercentage {
  id           String      @id @default(cuid())
  percentage   Int
  quarter      String
  schoolYearId String      @map("school_year_id")
  schoolId     String      @map("school_id")
  deletedAt    DateTime?   @map("deleted_at")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  schoolYear   SchoolYear  @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)

  @@unique([schoolYearId, quarter])
  @@index([schoolYearId])
  @@map("quarter_grade_percentages")
}

model ProjectionMonthlyGoal {
  id                  String                      @id @default(cuid())
  projectionId        String                      @map("projection_id")
  monthlyGoalTemplateId String                    @map("monthly_goal_template_id")
  grade               Int?
  status              ProjectionMonthlyGoalStatus @default(PENDING)
  deletedAt           DateTime?                   @map("deleted_at")
  createdAt           DateTime                    @default(now()) @map("created_at")
  updatedAt           DateTime                    @updatedAt @map("updated_at")
  projection          Projection                  @relation(fields: [projectionId], references: [id], onDelete: Cascade)
  monthlyGoalTemplate MonthlyGoalTemplate        @relation(fields: [monthlyGoalTemplateId], references: [id], onDelete: Cascade)
  gradeHistory        MonthlyGoalGradeHistory[]

  @@unique([projectionId, monthlyGoalTemplateId])
  @@index([projectionId])
  @@index([projectionId, status])
  @@map("projection_monthly_goals")
}

model MonthlyGoalGradeHistory {
  id                    String                @id @default(cuid())
  grade                 Int
  date                  DateTime              @default(now())
  note                  String?
  projectionMonthlyGoalId String              @map("projection_monthly_goal_id")
  createdAt             DateTime              @default(now()) @map("created_at")
  projectionMonthlyGoal ProjectionMonthlyGoal @relation(fields: [projectionMonthlyGoalId], references: [id], onDelete: Cascade)

  @@index([projectionMonthlyGoalId])
  @@map("monthly_goal_grade_history")
}

model Category {
  id                 String              @id @default(cuid())
  name               String              @unique
  description        String?
  displayOrder       Int                 @default(0) @map("display_order")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  subjects           Subject[]
  paceCatalogs       PaceCatalog[]

  @@map("categories")
}

model Level {
  id          String       @id
  number      Int?
  name        String
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  subjects Subject[]

  @@map("levels")
}

model Subject {
  id                         String                      @id @default(cuid())
  name                       String
  difficulty                 Int                         @default(3)
  categoryId                 String                      @map("category_id")
  levelId                    String                      @map("level_id")
  createdAt                  DateTime                    @default(now()) @map("created_at")
  updatedAt                  DateTime                    @updatedAt @map("updated_at")
  paces                      PaceCatalog[]
  category                   Category                    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  level                      Level                       @relation(fields: [levelId], references: [id])

  @@unique([categoryId, name])
  @@index([categoryId])
  @@index([levelId])
  @@map("subjects")
}

model PaceCatalog {
  id              String           @id @default(cuid())
  code            String
  name            String
  orderIndex      Int              @map("order_index")
  subjectId       String           @map("subject_id")
  categoryId      String?          @map("category_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  subject         Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  category        Category?        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  projectionPaces ProjectionPace[]

  @@unique([subjectId, code])
  @@unique([subjectId, orderIndex])
  @@index([subjectId])
  @@index([categoryId])
  @@index([orderIndex])
  @@map("pace_catalog")
}

enum ProjectionPaceStatus {
  PENDING
  COMPLETED
  FAILED
  UNFINISHED
}

model ProjectionPace {
  id            String         @id @default(cuid())
  projectionId  String         @map("projection_id")
  paceCatalogId String         @map("pace_catalog_id")
  quarter       String
  week          Int
  grade         Int?
  status        ProjectionPaceStatus @default(PENDING)
  originalQuarter String?       @map("original_quarter")
  originalWeek    Int?          @map("original_week")
  deletedAt     DateTime?      @map("deleted_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  gradeHistory  GradeHistory[]
  paceCatalog   PaceCatalog    @relation(fields: [paceCatalogId], references: [id])
  projection    Projection     @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  @@unique([projectionId, paceCatalogId])
  @@index([projectionId])
  @@index([projectionId, quarter, week])
  @@index([projectionId, status])
  @@map("projection_paces")
}

model GradeHistory {
  id               String         @id @default(cuid())
  grade            Int
  date             DateTime       @default(now())
  note             String?
  projectionPaceId String         @map("projection_pace_id")
  createdAt        DateTime       @default(now()) @map("created_at")
  projectionPace   ProjectionPace @relation(fields: [projectionPaceId], references: [id], onDelete: Cascade)

  @@index([projectionPaceId])
  @@map("grade_history")
}

model DailyGoal {
  id             String        @id @default(cuid())
  subject        String
  quarter        String
  week           Int
  dayOfWeek      Int
  text           String
  isCompleted    Boolean       @default(false)
  notes          String?
  notesCompleted Boolean       @default(false)
  projectionId   String
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  projection     Projection    @relation(fields: [projectionId], references: [id], onDelete: Cascade)
  notesHistory   NoteHistory[]

  @@index([projectionId])
  @@index([projectionId, quarter, week])
  @@map("daily_goals")
}

model NoteHistory {
  id            String    @id @default(cuid())
  text          String
  completedDate DateTime  @default(now()) @map("completed_date")
  dailyGoalId   String    @map("daily_goal_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  dailyGoal     DailyGoal @relation(fields: [dailyGoalId], references: [id], onDelete: Cascade)

  @@index([dailyGoalId])
  @@map("note_history")
}
