generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id                  String               @id @default(cuid())
  name                String
  address             String?
  phone               String?
  email               String?
  deletedAt           DateTime?            @map("deleted_at")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  teacherLimit        Int?                 @map("teacher_limit")
  userLimit           Int?                 @map("user_limit")
  isActive            Boolean              @default(true) @map("is_active")
  certificationTypes  CertificationType[]
  groups              Group[]
  projectionTemplates ProjectionTemplate[]
  roles               Role[]
  roleModuleSchools   RoleModuleSchool[]
  schoolModules       SchoolModule[]
  schoolYears         SchoolYear[]
  students            Student[]
  users               User[]

  @@map("schools")
}

model User {
  id              String           @id @default(cuid())
  clerkId         String?          @unique @map("clerk_id")
  email           String           @unique
  firstName       String?          @map("first_name")
  lastName        String?          @map("last_name")
  schoolId        String           @map("school_id")
  deletedAt       DateTime?        @map("deleted_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  language        String?          @default("es")
  isActive        Boolean          @default(true) @map("is_active")
  createdPassword Boolean          @default(false) @map("created_password")
  groups          Group[]          @relation("GroupTeacher")
  student         Student?
  teacherStudents TeacherStudent[] @relation("TeacherStudents")
  userRoles       UserRole[]
  userStudents    UserStudent[]
  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([clerkId])
  @@index([isActive])
  @@map("users")
}

model SchoolYear {
  id                               String                            @id @default(cuid())
  schoolId                         String                            @map("school_id")
  name                             String
  startDate                        DateTime                          @map("start_date")
  endDate                          DateTime                          @map("end_date")
  isActive                         Boolean                           @default(false) @map("is_active")
  deletedAt                        DateTime?                         @map("deleted_at")
  createdAt                        DateTime                          @default(now()) @map("created_at")
  updatedAt                        DateTime                          @updatedAt @map("updated_at")
  groups                           Group[]
  quarterGradePercentages          QuarterGradePercentage[]
  quarterHolidays                  QuarterHoliday[]
  quarters                         Quarter[]
  schoolMonthlyAssignmentTemplates SchoolMonthlyAssignmentTemplate[]
  school                           School                            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacherStudents                  TeacherStudent[]

  @@index([schoolId, isActive])
  @@map("school_years")
}

model Quarter {
  id              String           @id @default(cuid())
  schoolYearId    String           @map("school_year_id")
  name            String
  displayName     String           @map("display_name")
  startDate       DateTime         @map("start_date")
  endDate         DateTime         @map("end_date")
  order           Int
  weeksCount      Int              @default(9) @map("weeks_count")
  deletedAt       DateTime?        @map("deleted_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  quarterHolidays QuarterHoliday[]
  schoolYear      SchoolYear       @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  schoolWeeks     SchoolWeek[]

  @@unique([schoolYearId, name])
  @@unique([schoolYearId, order])
  @@index([schoolYearId])
  @@map("quarters")
}

model QuarterHoliday {
  id           String     @id @default(cuid())
  schoolYearId String     @map("school_year_id")
  quarterId    String?    @map("quarter_id")
  startDate    DateTime   @map("start_date")
  endDate      DateTime   @map("end_date")
  label        String?
  deletedAt    DateTime?  @map("deleted_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  quarter      Quarter?   @relation(fields: [quarterId], references: [id], onDelete: Cascade)
  schoolYear   SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)

  @@index([schoolYearId])
  @@index([quarterId])
  @@map("quarter_holidays")
}

model SchoolWeek {
  id         String    @id @default(cuid())
  quarterId  String    @map("quarter_id")
  weekNumber Int       @map("week_number")
  startDate  DateTime  @map("start_date")
  endDate    DateTime  @map("end_date")
  deletedAt  DateTime? @map("deleted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  quarter    Quarter   @relation(fields: [quarterId], references: [id], onDelete: Cascade)

  @@unique([quarterId, weekNumber])
  @@index([quarterId])
  @@map("school_weeks")
}

model CertificationType {
  id          String    @id @default(cuid())
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  schoolId    String    @map("school_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students    Student[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@map("certification_types")
}

model Student {
  id                  String            @id @default(cuid())
  birthDate           DateTime          @map("birth_date")
  graduationDate      DateTime          @map("graduation_date")
  contactPhone        String?           @map("contact_phone")
  isLeveled           Boolean           @default(false) @map("is_leveled")
  expectedLevel       String?           @map("expected_level")
  currentLevel        String?           @map("current_level")
  address             String?
  userId              String            @unique @map("user_id")
  schoolId            String            @map("school_id")
  certificationTypeId String            @map("certification_type_id")
  deletedAt           DateTime?         @map("deleted_at")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")
  groupStudents       GroupStudent[]
  projections         Projection[]
  certificationType   CertificationType @relation(fields: [certificationTypeId], references: [id])
  school              School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacherStudents     TeacherStudent[]
  userStudents        UserStudent[]

  @@index([schoolId])
  @@index([certificationTypeId])
  @@map("students")
}

model Projection {
  id                 String              @id @default(cuid())
  schoolYear         String
  startDate          DateTime
  endDate            DateTime
  isActive           Boolean             @default(true)
  notes              String?
  studentId          String
  deletedAt          DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  dailyGoals         DailyGoal[]
  monthlyAssignments MonthlyAssignment[]
  projectionPaces    ProjectionPace[]
  student            Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([studentId, isActive])
  @@map("projections")
}

model ProjectionTemplate {
  id               String                      @id @default(cuid())
  name             String
  level            String
  isDefault        Boolean                     @default(false) @map("is_default")
  isActive         Boolean                     @default(true) @map("is_active")
  schoolId         String                      @map("school_id")
  deletedAt        DateTime?                   @map("deleted_at")
  createdAt        DateTime                    @default(now()) @map("created_at")
  updatedAt        DateTime                    @updatedAt @map("updated_at")
  templateSubjects ProjectionTemplateSubject[]
  school           School                      @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, level, name])
  @@index([schoolId])
  @@index([schoolId, level])
  @@map("projection_templates")
}

model ProjectionTemplateSubject {
  id           String             @id @default(cuid())
  templateId   String             @map("template_id")
  subSubjectId String             @map("sub_subject_id")
  startPace    Int                @map("start_pace")
  endPace      Int                @map("end_pace")
  skipPaces    Int[]              @default([]) @map("skip_paces")
  notPairWith  String[]           @default([]) @map("not_pair_with")
  extendToNext Boolean            @default(false) @map("extend_to_next")
  order        Int                @default(0)
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  subSubject   SubSubject         @relation(fields: [subSubjectId], references: [id], onDelete: Cascade)
  template     ProjectionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, subSubjectId])
  @@index([templateId])
  @@index([subSubjectId])
  @@map("projection_template_subjects")
}

model Role {
  id                String             @id @default(cuid())
  name              String
  displayName       String             @map("display_name")
  description       String?
  isSystem          Boolean            @default(false) @map("is_system")
  isActive          Boolean            @default(true) @map("is_active")
  schoolId          String?            @map("school_id")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  school            School?            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  roleModuleSchools RoleModuleSchool[]
  userRoles         UserRole[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([name])
  @@map("roles")
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  roleId     String   @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Module {
  id                String             @id @default(cuid())
  name              String
  description       String?
  displayOrder      Int                @default(0) @map("display_order")
  isActive          Boolean            @default(true) @map("is_active")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  key               String             @unique
  roleModuleSchools RoleModuleSchool[]
  schoolModules     SchoolModule[]

  @@map("modules")
}

model SchoolModule {
  id        String   @id @default(cuid())
  schoolId  String   @map("school_id")
  moduleId  String   @map("module_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, moduleId])
  @@index([schoolId])
  @@index([moduleId])
  @@map("school_modules")
}

model RoleModuleSchool {
  id        String   @id @default(cuid())
  roleId    String   @map("role_id")
  schoolId  String   @map("school_id")
  moduleId  String   @map("module_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([roleId, schoolId, moduleId])
  @@index([roleId])
  @@index([schoolId])
  @@index([moduleId])
  @@map("roles_modules_school")
}

model UserStudent {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  studentId    String   @map("student_id")
  relationship String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, studentId])
  @@index([userId])
  @@index([studentId])
  @@map("user_students")
}

model TeacherStudent {
  id           String     @id @default(cuid())
  teacherId    String     @map("teacher_id")
  studentId    String     @map("student_id")
  schoolYearId String     @map("school_year_id")
  deletedAt    DateTime?  @map("deleted_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  name         String?
  schoolYear   SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher      User       @relation("TeacherStudents", fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, studentId, schoolYearId])
  @@index([teacherId])
  @@index([studentId])
  @@index([schoolYearId])
  @@index([teacherId, schoolYearId, deletedAt])
  @@index([studentId, schoolYearId, deletedAt])
  @@map("teacher_students")
}

model Group {
  id            String         @id @default(cuid())
  name          String?
  teacherId     String         @map("teacher_id")
  schoolYearId  String         @map("school_year_id")
  schoolId      String         @map("school_id")
  deletedAt     DateTime?      @map("deleted_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  groupStudents GroupStudent[]
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolYear    SchoolYear     @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  teacher       User           @relation("GroupTeacher", fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, schoolYearId, name])
  @@index([teacherId])
  @@index([schoolYearId])
  @@index([schoolId])
  @@index([teacherId, schoolYearId, deletedAt])
  @@map("groups")
}

model GroupStudent {
  id        String    @id @default(cuid())
  groupId   String    @map("group_id")
  studentId String    @map("student_id")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  group     Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student   Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
  @@index([groupId, deletedAt])
  @@index([studentId, deletedAt])
  @@map("group_students")
}

model Category {
  id           String       @id @default(cuid())
  name         String       @unique
  description  String?
  displayOrder Int          @default(0) @map("display_order")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  subSubjects  SubSubject[]

  @@map("categories")
}

model Level {
  id          String       @id
  number      Int?
  name        String
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  subSubjects SubSubject[]

  @@map("levels")
}

model SubSubject {
  id                         String                      @id @default(cuid())
  name                       String
  difficulty                 Int                         @default(3)
  categoryId                 String                      @map("category_id")
  levelId                    String                      @map("level_id")
  createdAt                  DateTime                    @default(now()) @map("created_at")
  updatedAt                  DateTime                    @updatedAt @map("updated_at")
  paces                      PaceCatalog[]
  projectionTemplateSubjects ProjectionTemplateSubject[]
  category                   Category                    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  level                      Level                       @relation(fields: [levelId], references: [id])

  @@unique([categoryId, name])
  @@index([categoryId])
  @@index([levelId])
  @@map("sub_subjects")
}

model PaceCatalog {
  id              String           @id @default(cuid())
  code            String
  name            String
  subSubjectId    String           @map("sub_subject_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  subSubject      SubSubject       @relation(fields: [subSubjectId], references: [id], onDelete: Cascade)
  projectionPaces ProjectionPace[]

  @@unique([subSubjectId, code])
  @@index([subSubjectId])
  @@map("pace_catalog")
}

model ProjectionPace {
  id            String         @id @default(cuid())
  projectionId  String         @map("projection_id")
  paceCatalogId String         @map("pace_catalog_id")
  quarter       String
  week          Int
  grade         Int?
  isCompleted   Boolean        @default(false) @map("is_completed")
  isFailed      Boolean        @default(false) @map("is_failed")
  comments      String?
  deletedAt     DateTime?      @map("deleted_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  gradeHistory  GradeHistory[]
  paceCatalog   PaceCatalog    @relation(fields: [paceCatalogId], references: [id])
  projection    Projection     @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  @@unique([projectionId, paceCatalogId])
  @@index([projectionId])
  @@index([projectionId, quarter, week])
  @@map("projection_paces")
}

model GradeHistory {
  id               String         @id @default(cuid())
  grade            Int
  date             DateTime       @default(now())
  note             String?
  projectionPaceId String         @map("projection_pace_id")
  createdAt        DateTime       @default(now()) @map("created_at")
  projectionPace   ProjectionPace @relation(fields: [projectionPaceId], references: [id], onDelete: Cascade)

  @@index([projectionPaceId])
  @@map("grade_history")
}

model DailyGoal {
  id             String        @id @default(cuid())
  subject        String
  quarter        String
  week           Int
  dayOfWeek      Int
  text           String
  isCompleted    Boolean       @default(false)
  notes          String?
  notesCompleted Boolean       @default(false)
  projectionId   String
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  projection     Projection    @relation(fields: [projectionId], references: [id], onDelete: Cascade)
  notesHistory   NoteHistory[]

  @@index([projectionId])
  @@index([projectionId, quarter, week])
  @@map("daily_goals")
}

model NoteHistory {
  id            String    @id @default(cuid())
  text          String
  completedDate DateTime  @default(now()) @map("completed_date")
  dailyGoalId   String    @map("daily_goal_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  dailyGoal     DailyGoal @relation(fields: [dailyGoalId], references: [id], onDelete: Cascade)

  @@index([dailyGoalId])
  @@map("note_history")
}

model MonthlyAssignment {
  id           String                          @id @default(cuid())
  name         String
  quarter      String
  grade        Int?
  projectionId String                          @map("projection_id")
  deletedAt    DateTime?                       @map("deleted_at")
  createdAt    DateTime                        @default(now()) @map("created_at")
  updatedAt    DateTime                        @updatedAt @map("updated_at")
  gradeHistory MonthlyAssignmentGradeHistory[]
  projection   Projection                      @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  @@index([projectionId])
  @@index([projectionId, quarter])
  @@map("monthly_assignments")
}

model MonthlyAssignmentGradeHistory {
  id                  String            @id @default(cuid())
  grade               Int
  date                DateTime          @default(now())
  note                String?
  monthlyAssignmentId String            @map("monthly_assignment_id")
  createdAt           DateTime          @default(now()) @map("created_at")
  monthlyAssignment   MonthlyAssignment @relation(fields: [monthlyAssignmentId], references: [id], onDelete: Cascade)

  @@index([monthlyAssignmentId])
  @@map("monthly_assignment_grade_history")
}

model SchoolMonthlyAssignmentTemplate {
  id           String     @id @default(cuid())
  name         String
  quarter      String
  schoolYearId String     @map("school_year_id")
  deletedAt    DateTime?  @map("deleted_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  schoolYear   SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)

  @@unique([schoolYearId, quarter, name])
  @@index([schoolYearId])
  @@index([schoolYearId, quarter])
  @@map("school_monthly_assignment_templates")
}

model QuarterGradePercentage {
  id           String     @id @default(cuid())
  percentage   Int
  quarter      String
  schoolYearId String     @map("school_year_id")
  deletedAt    DateTime?  @map("deleted_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  schoolYear   SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)

  @@unique([schoolYearId, quarter])
  @@index([schoolYearId])
  @@index([schoolYearId, quarter])
  @@map("quarter_grade_percentages")
}
