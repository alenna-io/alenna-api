// Prisma Schema for Alenna SaaS
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenancy: Each school is a tenant
model School {
  id      String  @id @default(cuid())
  name    String
  address String?
  phone   String?
  email   String?

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  users              User[]
  students           Student[]
  certificationTypes CertificationType[]
  roles              Role[] // School-specific custom roles
  schoolModules      SchoolModule[]
  roleModuleSchools  RoleModuleSchool[]
  schoolYears        SchoolYear[]
  projectionTemplates ProjectionTemplate[]

  @@map("schools")
}

// Users belong to a school and are authenticated via Clerk
model User {
  id        String  @id @default(cuid())
  clerkId   String  @unique @map("clerk_id")
  email     String  @unique
  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  schoolId  String  @map("school_id")
  school    School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  userRoles    UserRole[]
  userStudents UserStudent[]
  student      Student?

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([schoolId])
  @@index([clerkId])
  @@map("users")
}

// Removed UserRole enum - now using Role table

// School Year configuration - defines when school year starts/ends and quarter dates
model SchoolYear {
  id        String   @id @default(cuid())
  schoolId  String   @map("school_id")
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name      String // e.g., "2024-2025"
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  isActive  Boolean  @default(false) @map("is_active") // Only one active per school

  quarters Quarter[]
  schoolMonthlyAssignmentTemplates SchoolMonthlyAssignmentTemplate[]
  quarterGradePercentages QuarterGradePercentage[]

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([schoolId, isActive])
  @@map("school_years")
}

// Quarter configuration - defines start/end dates for each of 4 quarters
model Quarter {
  id           String     @id @default(cuid())
  schoolYearId String     @map("school_year_id")
  schoolYear   SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  name         String // Q1, Q2, Q3, Q4
  displayName  String     @map("display_name") // "Bloque 1", etc.
  startDate    DateTime   @map("start_date")
  endDate      DateTime   @map("end_date")
  order        Int // 1, 2, 3, 4
  weeksCount   Int        @default(9) @map("weeks_count") // Usually 9 weeks per quarter

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([schoolYearId, name])
  @@unique([schoolYearId, order])
  @@index([schoolYearId])
  @@map("quarters")
}

// Certification types per school (tenant-scoped)
model CertificationType {
  id          String  @id @default(cuid())
  name        String
  description String?
  isActive    Boolean @default(true) @map("is_active")

  schoolId String @map("school_id")
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  students Student[]

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([schoolId, name])
  @@index([schoolId])
  @@map("certification_types")
}

// Students belong to a school and are linked to a User account
model Student {
  id             String   @id @default(cuid())
  birthDate      DateTime @map("birth_date")
  graduationDate DateTime @map("graduation_date")
  contactPhone   String?  @map("contact_phone")
  isLeveled      Boolean  @default(false) @map("is_leveled")
  expectedLevel  String?  @map("expected_level")
  currentLevel   String?  @map("current_level")
  address        String?

  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  schoolId String @map("school_id")
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  certificationTypeId String            @map("certification_type_id")
  certificationType   CertificationType @relation(fields: [certificationTypeId], references: [id], onDelete: Restrict)

  userStudents UserStudent[]
  projections  Projection[]

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([schoolId])
  @@index([certificationTypeId])
  @@map("students")
}

// Projection: Yearly PACE plan for a student
model Projection {
  id         String   @id @default(cuid())
  schoolYear String // e.g., "2024-2025"
  startDate  DateTime
  endDate    DateTime
  isActive   Boolean  @default(true)
  notes      String?

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  projectionPaces     ProjectionPace[]
  dailyGoals          DailyGoal[]
  monthlyAssignments  MonthlyAssignment[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([studentId])
  @@index([studentId, isActive])
  @@map("projections")
}

// Projection Template - Pre-configured templates for each level (L1-L8)
model ProjectionTemplate {
  id        String  @id @default(cuid())
  name      String  // e.g., "Level 1 Template", "Standard L1"
  level     String  // L1, L2, L3, L4, L5, L6, L7, L8
  isDefault Boolean @default(false) @map("is_default")
  isActive  Boolean @default(true) @map("is_active")

  schoolId String @map("school_id")
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  templateSubjects ProjectionTemplateSubject[]

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([schoolId, level, name])
  @@index([schoolId])
  @@index([schoolId, level])
  @@map("projection_templates")
}

// Projection Template Subject - Subjects and pace ranges for each template
model ProjectionTemplateSubject {
  id         String  @id @default(cuid())
  templateId String  @map("template_id")
  template   ProjectionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  subSubjectId String    @map("sub_subject_id")
  subSubject   SubSubject @relation(fields: [subSubjectId], references: [id], onDelete: Cascade)

  startPace    Int       @map("start_pace")
  endPace      Int       @map("end_pace")
  skipPaces    Int[]     @default([]) @map("skip_paces")
  notPairWith  String[]  @default([]) @map("not_pair_with") // Array of other subSubjectIds
  extendToNext Boolean   @default(false) @map("extend_to_next")

  order Int @default(0) // Display order within template

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([templateId, subSubjectId])
  @@index([templateId])
  @@index([subSubjectId])
  @@map("projection_template_subjects")
}

// ============================================
// RBAC & MODULE SYSTEM
// ============================================

// Role - User roles (can be system-wide or school-specific)
model Role {
  id          String  @id @default(cuid())
  name        String
  displayName String  @map("display_name")
  description String?
  isSystem    Boolean @default(false) @map("is_system")
  isActive    Boolean @default(true) @map("is_active")

  schoolId String? @map("school_id")
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  userRoles         UserRole[]
  roleModuleSchools RoleModuleSchool[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([name])
  @@map("roles")
}

// User-Role join table (many-to-many)
model UserRole {
  id String @id @default(cuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  roleId String @map("role_id")
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now()) @map("assigned_at")

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// Module - Feature modules (Students, Users, Payments, etc.)
model Module {
  id           String  @id @default(cuid())
  key          String  @unique
  name         String
  description  String?
  displayOrder Int     @default(0) @map("display_order")
  isActive     Boolean @default(true) @map("is_active")

  schoolModules     SchoolModule[]
  roleModuleSchools RoleModuleSchool[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("modules")
}

// School Module - Which modules are enabled for a school
model SchoolModule {
  id String @id @default(cuid())

  schoolId String @map("school_id")
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  moduleId String @map("module_id")
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([schoolId, moduleId])
  @@index([schoolId])
  @@index([moduleId])
  @@map("school_modules")
}

// Role-Module assignment per school (which roles can access which modules at a school)
model RoleModuleSchool {
  id String @id @default(cuid())

  roleId String @map("role_id")
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  schoolId String @map("school_id")
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  moduleId String @map("module_id")
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([roleId, schoolId, moduleId])
  @@index([roleId])
  @@index([schoolId])
  @@index([moduleId])
  @@map("roles_modules_school")
}

// User-Student relationship (for PARENT role - links parents to their children)
model UserStudent {
  id String @id @default(cuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  studentId String  @map("student_id")
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  relationship String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, studentId])
  @@index([userId])
  @@index([studentId])
  @@map("user_students")
}

// ============================================
// PACE CATALOG SYSTEM
// ============================================

// Category (Mega Subject) - e.g., Math, English, Science
model Category {
  id           String  @id @default(cuid())
  name         String  @unique
  description  String?
  displayOrder Int     @default(0) @map("display_order")

  subSubjects SubSubject[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("categories")
}

// Level - L1 to L12
model Level {
  id     String @id
  number Int?
  name   String

  subSubjects SubSubject[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("levels")
}

// SubSubject - Specific subject within a category (e.g., Math 1, Trigonometry)
model SubSubject {
  id         String @id @default(cuid())
  name       String
  difficulty Int    @default(3)

  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  levelId String @map("level_id")
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Restrict)

  paces                    PaceCatalog[]
  projectionTemplateSubjects ProjectionTemplateSubject[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([categoryId, name])
  @@index([categoryId])
  @@index([levelId])
  @@map("sub_subjects")
}

// PaceCatalog - Master PACE list (shared across all students)
model PaceCatalog {
  id   String @id @default(cuid())
  code String
  name String

  subSubjectId String     @map("sub_subject_id")
  subSubject   SubSubject @relation(fields: [subSubjectId], references: [id], onDelete: Cascade)

  projectionPaces ProjectionPace[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([subSubjectId, code])
  @@index([subSubjectId])
  @@map("pace_catalog")
}

// ============================================
// STUDENT PACE TRACKING
// ============================================

// ProjectionPace - Student-specific PACE tracking (links to catalog)
model ProjectionPace {
  id String @id @default(cuid())

  projectionId String     @map("projection_id")
  projection   Projection @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  paceCatalogId String      @map("pace_catalog_id")
  paceCatalog   PaceCatalog @relation(fields: [paceCatalogId], references: [id], onDelete: Restrict)

  quarter     String
  week        Int
  grade       Int?
  isCompleted Boolean @default(false) @map("is_completed")
  isFailed    Boolean @default(false) @map("is_failed")
  comments    String?

  gradeHistory GradeHistory[]

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([projectionId, paceCatalogId])
  @@index([projectionId])
  @@index([projectionId, quarter, week])
  @@map("projection_paces")
}

// Grade history for each student's PACE attempt
model GradeHistory {
  id    String   @id @default(cuid())
  grade Int
  date  DateTime @default(now())
  note  String?

  projectionPaceId String         @map("projection_pace_id")
  projectionPace   ProjectionPace @relation(fields: [projectionPaceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([projectionPaceId])
  @@map("grade_history")
}

// Daily Goals
model DailyGoal {
  id             String  @id @default(cuid())
  subject        String // Math, English, Science, Social Studies, Word Building, Spanish
  quarter        String // Q1, Q2, Q3, Q4
  week           Int // 1-9
  dayOfWeek      Int // 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri
  text           String // Goal text (e.g., "1-10" or "Self Test")
  isCompleted    Boolean @default(false)
  notes          String?
  notesCompleted Boolean @default(false)

  projectionId String
  projection   Projection @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  notesHistory NoteHistory[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([projectionId])
  @@index([projectionId, quarter, week])
  @@map("daily_goals")
}

// Notes history for daily goals
model NoteHistory {
  id            String   @id @default(cuid())
  text          String
  completedDate DateTime @default(now()) @map("completed_date")

  dailyGoalId String    @map("daily_goal_id")
  dailyGoal   DailyGoal @relation(fields: [dailyGoalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([dailyGoalId])
  @@map("note_history")
}

// Monthly Assignments - Quarterly assignments (oral reports, verses, etc.)
model MonthlyAssignment {
  id      String @id @default(cuid())
  name    String // Assignment name (e.g., "Oral Report", "Bible Verse")
  quarter String // Q1, Q2, Q3, Q4
  grade   Int? // Grade 0-100, null if not graded yet

  projectionId String     @map("projection_id")
  projection   Projection @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  gradeHistory MonthlyAssignmentGradeHistory[]

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([projectionId])
  @@index([projectionId, quarter])
  @@map("monthly_assignments")
}

// Grade history for monthly assignments (for retakes)
model MonthlyAssignmentGradeHistory {
  id    String   @id @default(cuid())
  grade Int
  date  DateTime @default(now())
  note  String?

  monthlyAssignmentId String            @map("monthly_assignment_id")
  monthlyAssignment   MonthlyAssignment @relation(fields: [monthlyAssignmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([monthlyAssignmentId])
  @@map("monthly_assignment_grade_history")
}

// School-level Monthly Assignment Templates - Templates that apply to all students
model SchoolMonthlyAssignmentTemplate {
  id         String     @id @default(cuid())
  name       String     // Assignment name (e.g., "Oral Report", "Bible Verse")
  quarter    String     // Q1, Q2, Q3, Q4
  schoolYearId String   @map("school_year_id")
  schoolYear SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([schoolYearId, quarter, name])
  @@index([schoolYearId])
  @@index([schoolYearId, quarter])
  @@map("school_monthly_assignment_templates")
}

// Quarter Grade Percentage - Percentage that monthly assignments represent per quarter
model QuarterGradePercentage {
  id           String     @id @default(cuid())
  percentage   Int        // Percentage (0-100) that monthly assignments represent
  quarter      String     // Q1, Q2, Q3, Q4
  schoolYearId String     @map("school_year_id")
  schoolYear   SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([schoolYearId, quarter])
  @@index([schoolYearId])
  @@index([schoolYearId, quarter])
  @@map("quarter_grade_percentages")
}
