// Prisma Schema for Alenna SaaS
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenancy: Each school is a tenant
model School {
  id      String  @id @default(cuid())
  name    String
  address String?
  phone   String?
  email   String?

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  users              User[]
  students           Student[]
  certificationTypes CertificationType[]
  roles              Role[] // School-specific custom roles
  schoolModules      SchoolModule[]

  @@map("schools")
}

// Users belong to a school and are authenticated via Clerk
model User {
  id        String  @id @default(cuid())
  clerkId   String  @unique // Clerk user ID
  email     String  @unique
  firstName String?
  lastName  String?
  schoolId  String
  school    School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  userRoles    UserRole[] // Many-to-many with Role
  userModules  UserModule[]
  userStudents UserStudent[] // For PARENT role - children they can access
  student      Student? // If user is a student, link to Student record

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([schoolId])
  @@index([clerkId])
  @@map("users")
}

// Removed UserRole enum - now using Role table

// Certification types per school (tenant-scoped)
model CertificationType {
  id          String  @id @default(cuid())
  name        String // e.g., "INEA", "Grace Christian", "Home Life", etc.
  description String?
  isActive    Boolean @default(true)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  students Student[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([schoolId, name]) // Unique certification name per school
  @@index([schoolId])
  @@map("certification_types")
}

// Students belong to a school and are linked to a User account
model Student {
  id             String   @id @default(cuid())
  birthDate      DateTime
  graduationDate DateTime
  contactPhone   String?
  isLeveled      Boolean  @default(false)
  expectedLevel  String?
  currentLevel   String? // Current ACE level (L1-L12)
  address        String?

  userId String @unique // Each student is a user with STUDENT role
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  certificationTypeId String
  certificationType   CertificationType @relation(fields: [certificationTypeId], references: [id], onDelete: Restrict)

  userStudents UserStudent[] // Parents linked to this student
  projections  Projection[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([schoolId])
  @@index([certificationTypeId])
  @@map("students")
}

// Projection: Yearly PACE plan for a student
model Projection {
  id         String   @id @default(cuid())
  schoolYear String // e.g., "2024-2025"
  startDate  DateTime
  endDate    DateTime
  isActive   Boolean  @default(true)
  notes      String?

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  projectionPaces ProjectionPace[]
  dailyGoals      DailyGoal[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([studentId])
  @@index([studentId, isActive])
  @@map("projections")
}

// ============================================
// RBAC & MODULE SYSTEM
// ============================================

// Role - User roles (can be system-wide or school-specific)
model Role {
  id          String  @id @default(cuid())
  name        String // ADMIN, TEACHER, STUDENT, PARENT, SUPERVISOR, etc.
  displayName String // Localized display name
  description String?
  isSystem    Boolean @default(false) // System roles can't be deleted
  isActive    Boolean @default(true)

  schoolId String? // NULL = global/system role, otherwise school-specific
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name]) // Role name unique per school (or globally if schoolId is null)
  @@index([schoolId])
  @@index([name])
  @@map("roles")
}

// User-Role join table (many-to-many)
model UserRole {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// Module - Feature modules (Students, Users, Payments, etc.)
model Module {
  id           String  @id @default(cuid())
  name         String  @unique // Students, Users, Configuration, Payments, Teachers, Parents
  description  String?
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  permissions   Permission[]
  schoolModules SchoolModule[]
  userModules   UserModule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("modules")
}

// Permission - Granular permissions within modules
model Permission {
  id          String  @id @default(cuid())
  name        String  @unique // students.read, students.create, projections.readOwn, etc.
  description String?

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  rolePermissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([moduleId])
  @@map("permissions")
}

// School Module - Which modules are enabled for a school
model SchoolModule {
  id String @id @default(cuid())

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, moduleId])
  @@index([schoolId])
  @@index([moduleId])
  @@map("school_modules")
}

// User Module - Which modules a user can access (within their school's available modules)
model UserModule {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
  @@map("user_modules")
}

// Role Permission - Permissions assigned to roles
model RolePermission {
  id String @id @default(cuid())

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// User-Student relationship (for PARENT role - links parents to their children)
model UserStudent {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  relationship String? // "Mother", "Father", "Guardian", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, studentId])
  @@index([userId])
  @@index([studentId])
  @@map("user_students")
}

// ============================================
// PACE CATALOG SYSTEM
// ============================================

// Category (Mega Subject) - e.g., Math, English, Science
model Category {
  id           String  @id @default(cuid())
  name         String  @unique // Bible Reading, Electives, English, Math, Science, Social Studies, Word Building, Spanish
  description  String?
  displayOrder Int     @default(0) // For sorting in UI

  subSubjects SubSubject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

// Level - L1 to L12
model Level {
  id     String @id // "L1" to "L12" or "Electives"
  number Int? // 1-12, null for special levels like "Electives"
  name   String // Display name

  subSubjects SubSubject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("levels")
}

// SubSubject - Specific subject within a category (e.g., Math 1, Trigonometry)
model SubSubject {
  id         String @id @default(cuid())
  name       String // e.g., "Math 1", "Trigonometry", "English I"
  difficulty Int    @default(3) // 1-5

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  levelId String
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Restrict)

  paces PaceCatalog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, name])
  @@index([categoryId])
  @@index([levelId])
  @@map("sub_subjects")
}

// PaceCatalog - Master PACE list (shared across all students)
model PaceCatalog {
  id   String @id @default(cuid())
  code String // e.g., "1001", "001", "097" - Same codes across all categories!
  name String // SubSubject name + code, e.g., "Math L1 - 1001"

  subSubjectId String
  subSubject   SubSubject @relation(fields: [subSubjectId], references: [id], onDelete: Cascade)

  projectionPaces ProjectionPace[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([subSubjectId, code]) // Code is unique per SubSubject, not globally
  @@index([subSubjectId])
  @@map("pace_catalog")
}

// ============================================
// STUDENT PACE TRACKING
// ============================================

// ProjectionPace - Student-specific PACE tracking (links to catalog)
model ProjectionPace {
  id String @id @default(cuid())

  projectionId String
  projection   Projection @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  paceCatalogId String
  paceCatalog   PaceCatalog @relation(fields: [paceCatalogId], references: [id], onDelete: Restrict)

  quarter     String // Q1, Q2, Q3, Q4
  week        Int // 1-9
  grade       Int? // 0-100, null if not graded
  isCompleted Boolean @default(false)
  isFailed    Boolean @default(false)
  comments    String? // Optional comments about this PACE

  gradeHistory GradeHistory[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([projectionId, paceCatalogId]) // Student can only have one instance of each PACE per projection
  @@index([projectionId])
  @@index([projectionId, quarter, week])
  @@map("projection_paces")
}

// Grade history for each student's PACE attempt
model GradeHistory {
  id    String   @id @default(cuid())
  grade Int
  date  DateTime @default(now())
  note  String?

  projectionPaceId String
  projectionPace   ProjectionPace @relation(fields: [projectionPaceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([projectionPaceId])
  @@map("grade_history")
}

// Daily Goals
model DailyGoal {
  id             String  @id @default(cuid())
  subject        String // Math, English, Science, Social Studies, Word Building, Spanish
  quarter        String // Q1, Q2, Q3, Q4
  week           Int // 1-9
  dayOfWeek      Int // 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri
  text           String // Goal text (e.g., "1-10" or "Self Test")
  isCompleted    Boolean @default(false)
  notes          String?
  notesCompleted Boolean @default(false)

  projectionId String
  projection   Projection @relation(fields: [projectionId], references: [id], onDelete: Cascade)

  notesHistory NoteHistory[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([projectionId])
  @@index([projectionId, quarter, week])
  @@map("daily_goals")
}

// Notes history for daily goals
model NoteHistory {
  id            String   @id @default(cuid())
  text          String
  completedDate DateTime @default(now())

  dailyGoalId String
  dailyGoal   DailyGoal @relation(fields: [dailyGoalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([dailyGoalId])
  @@map("note_history")
}
